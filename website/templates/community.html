<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - Krishi Mitra</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <style>
        :root {
            --primary-green: #2e7d32;
            --accent-green: #558b2f;
            --light-bg: #f0f4f0;
            --border-color: #ddd;
        }
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        body { 
            background-color: var(--light-bg); 
            color: #333;
            line-height: 1.6;
            padding-bottom: 80px; /* Space for bottom nav */
        }
        header.main-header {
            background: white;
            padding: 10px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-section img {
            width: 40px;
            height: auto;
        }
        .logo-section h1 {
            color: var(--primary-green);
            font-size: 1.4rem;
        }
        
        /* Translate Styling */
        #google_translate_element { margin-left: auto; }
        
        .search-container {
            background: white;
            padding: 15px 5%;
            display: flex;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
        }
        .search-area {
            width: 100%;
            max-width: 700px;
            display: flex;
            gap: 10px;
        }
        .search-area input {
            flex: 1;
            padding: 12px 20px;
            border-radius: 30px;
            border: 1px solid var(--border-color);
            background: #f9f9f9;
            outline: none;
        }
        .btn-primary {
            background: var(--primary-green);
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-primary:hover {
            background: var(--accent-green);
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            gap: 20px;
            padding: 20px 5%;
            max-width: 1400px;
            margin: 0 auto;
        }
        aside.sidebar {
            height: fit-content;
        }
        .sidebar-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .sidebar-box h3 {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sidebar ul { list-style: none; }
        .sidebar li {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 5px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar li.active, .sidebar li:hover {
            background: #e8f5e9;
            color: var(--primary-green);
            font-weight: 600;
        }
        .feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        .user-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .user-meta img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }
        .tag {
            background: #e8f5e9;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            color: var(--primary-green);
            margin-left: 5px;
        }
        .question-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        .card-actions {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .action-btn {
            background: none;
            border: none;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .action-btn:hover { color: var(--primary-green); }
        
        .hero-item {
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        /* Post Modal */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 500px; border-radius: 15px;
        }
        .modal input, .modal textarea, .modal select {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #2e7d32;
            display: flex; justify-content: space-around; padding: 12px 0; color: white;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .nav-item { text-align: center; font-size: 12px; color: white; text-decoration: none; cursor: pointer; flex: 1; }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 4px; }
        
        /* Comments Section */
        .comments-section { display: none; margin-top: 15px; background: #fafafa; padding: 10px; border-radius: 10px;}
        .comment { font-size: 0.9rem; border-bottom: 1px solid #eee; padding: 5px 0; }

        @media (max-width: 1024px) {
            .content-wrapper { grid-template-columns: 240px 1fr; }
            .sidebar-right { display: none; }
        }
        @media (max-width: 768px) {
            header.main-header { padding: 10px 15px; }
            .logo-section h1 { font-size: 1.1rem; }
            .content-wrapper { grid-template-columns: 1fr; padding: 15px; }
            aside.sidebar { display: none; }
            .sidebar-right { display: none; }
            .search-area { flex-direction: row; }
            .btn-primary { padding: 10px 15px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo-section">
            <img src="{{ url_for('static', filename='1.png') }}" alt="Logo">
            <h1>Krishi Mitra</h1>
        </div>
        <div id="google_translate_element"></div>
    </header>

    <div class="search-container">
        <div class="search-area">
            <input type="text" placeholder="Share your experience or ask a question..." onclick="openPostModal()">
            <button class="btn-primary" onclick="openPostModal()">Post</button>
        </div>
    </div>

    <div class="content-wrapper">
        <aside class="sidebar">
            <div class="sidebar-box">
                <h3>My Circles</h3>
                <ul>
                    <li class="active"><i class="fa fa-rss"></i> All Feed</li>
                    <li><i class="fa fa-wheat-awn"></i> Corn Growers</li>
                    <li><i class="fa fa-cow"></i> Dairy Farming</li>
                    <li><i class="fa fa-leaf"></i> Organic Methods</li>
                </ul>
            </div>
        </aside>
        
        <main class="feed" id="feedContainer">
            {% for post in posts %}
            <div class="card" id="post-{{ post.id }}">
                <div class="user-meta">
                    <img src="{{ post.avatar }}" alt="User">
                    <div>
                        <strong>{{ post.author }}</strong> <span class="tag">{{ post.tag }}</span>
                        <p style="font-size: 0.8rem; color: #888;">{{ post.time_ago }}</p>
                    </div>
                </div>
                <h2 class="question-title">{{ post.title }}</h2>
                <p>{{ post.content }}</p>
                <div class="card-actions">
                    <button class="action-btn" onclick="likePost('{{ post.id }}')">
                        <i class="fa fa-arrow-up"></i> <span id="like-count-{{ post.id }}">{{ post.likes }}</span>
                    </button>
                    <button class="action-btn" onclick="toggleComments('{{ post.id }}')">
                        <i class="fa fa-comment"></i> <span>Comment</span>
                    </button>
                    <button class="action-btn" onclick="sharePost('{{ post.title }}')">
                        <i class="fa fa-share"></i> <span>Share</span>
                    </button>
                </div>
                
                <div id="comments-{{ post.id }}" class="comments-section">
                    {% if post.comments %}
                        {% for comment in post.comments %}
                        <div class="comment"><strong>{{ comment.author }}:</strong> {{ comment.text }}</div>
                        {% endfor %}
                    {% endif %}
                    <div style="display:flex; margin-top:10px;">
                        <input type="text" id="input-comment-{{ post.id }}" placeholder="Write a comment..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px;">
                        <button onclick="postComment('{{ post.id }}')" style="margin-left:5px; background:var(--primary-green); color:white; border:none; padding:0 15px; border-radius:5px;">Send</button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card" style="text-align:center; padding:40px;">
                <i class="fas fa-users" style="font-size:3rem; color:#ddd; margin-bottom:10px;"></i>
                <p>No posts yet. Be the first to start a discussion!</p>
            </div>
            {% endfor %}
        </main>

        <aside class="sidebar sidebar-right">
            <div class="sidebar-box">
                <h3>Harvest Heroes</h3>
                {% for hero in heroes %}
                <div class="hero-item">
                    <span>
                    {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}üèÖ{% endif %}
                    {{ hero.full_name }}
                    </span>
                    <span style="font-weight:bold; color:var(--primary-green);">{{ hero.score }} pts</span>
                </div>
                {% else %}
                <p>No heroes yet.</p>
                {% endfor %}
            </div>
            <div class="sidebar-box" style="background: var(--primary-green); color: white; border: none;">
                <h3 style="color: #c8e6c9;">Market Tip</h3>
                <p style="font-size: 0.9rem;">Wheat prices are expected to rise by 5% next week.</p>
            </div>
        </aside>
    </div>

    <div id="postModal" class="modal">
        <div class="modal-content">
            <span onclick="document.getElementById('postModal').style.display='none'" style="float:right; font-size:24px; cursor:pointer;">&times;</span>
            <h2 style="color:var(--primary-green);">Create Post</h2>
            <input type="text" id="postTitle" placeholder="Title (e.g. Disease in Wheat)">
            <select id="postTag">
                <option value="General">General</option>
                <option value="Crops">Crops</option>
                <option value="Livestock">Livestock</option>
                <option value="Market">Market Prices</option>
            </select>
            <textarea id="postContent" rows="4" placeholder="Describe your issue or tip..."></textarea>
            <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="submitPost()">Post Now</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="{{ url_for('views.home') }}" class="nav-item"><i class="fas fa-home"></i>Home</a>
        <a href="{{ url_for('views.my_farm') }}" class="nav-item"><i class="fas fa-tractor"></i>My Farm</a>
        <a href="{{ url_for('views.marketplace') }}" class="nav-item"><i class="fas fa-store"></i>Market</a>
        <a href="{{ url_for('views.profile') }}" class="nav-item"><i class="fas fa-user"></i>Profile</a>
    </nav>

    <script>
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,hi,pa,mr,gu,bn,ta,te', 
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE
            }, 'google_translate_element');
        }

        function openPostModal() {
            document.getElementById('postModal').style.display = 'block';
        }

        async function submitPost() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const tag = document.getElementById('postTag').value;

            if(!title || !content) { alert("Please fill all fields"); return; }

            const response = await fetch('/community/post', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title, content, tag })
            });
            
            const result = await response.json();
            if(result.success) {
                location.reload();
            } else {
                alert(result.message || "Error posting");
            }
        }

        async function likePost(postId) {
            const response = await fetch('/community/like/' + postId, { method: 'POST' });
            if(response.ok) {
                const countSpan = document.getElementById('like-count-' + postId);
                countSpan.innerText = parseInt(countSpan.innerText) + 1;
            }
        }

        function toggleComments(postId) {
            const section = document.getElementById('comments-' + postId);
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        async function postComment(postId) {
            const input = document.getElementById('input-comment-' + postId);
            const text = input.value;
            if(!text) return;

            const response = await fetch('/community/comment/' + postId, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ comment: text })
            });

            if(response.ok) {
                location.reload(); 
            }
        }

        function sharePost(title) {
            if (navigator.share) {
                navigator.share({
                    title: 'Krishi Mitra Community',
                    text: title,
                    url: window.location.href,
                });
            } else {
                alert("Sharing not supported on this browser.");
            }
        }
    </script>
</body>
</html>